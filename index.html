<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://YOUR_SUPABASE_URL.supabase.co; worker-src 'self' blob:;">
    <title>Mutuelle Calculateur</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            margin-bottom: 20px;
            max-width: 1400px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            color: #718096;
            font-size: 1.1em;
        }

        .upload-section {
            text-align: center;
            padding: 40px;
        }

        .upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 60px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f7fafc 0%, #edf2f7 100%);
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: linear-gradient(45deg, #edf2f7 0%, #e2e8f0 100%);
            transform: translateY(-2px);
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 4em;
            color: #a0aec0;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #718096;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 5px;
        }

        .btn-download {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
            padding: 8px 16px;
            font-size: 0.9em;
            margin: 5px;
        }

        .btn-download:hover {
            box-shadow: 0 8px 16px rgba(56, 178, 172, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-success:hover {
            box-shadow: 0 8px 16px rgba(56, 161, 105, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .amount {
            font-size: 2.2em;
            font-weight: bold;
        }

        .details-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .table-controls {
            padding: 15px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-controls label {
            font-weight: 500;
            color: #4a5568;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        th:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        .amount-cell {
            text-align: right;
            font-weight: 500;
        }

        .positive {
            color: #38a169;
        }

        .negative {
            color: #e53e3e;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #edf2f7;
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cotisation-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .year-section {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f7fafc;
        }

        .year-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .form-group input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .calculations {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .calc-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #e53e3e;
        }

        .success-message {
            background: #c6f6d5;
            color: #2d5016;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #48bb78;
        }

        .privacy-notice {
            background: #e6fffa;
            color: #234e52;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #38b2ac;
        }

        .privacy-notice strong {
            color: #1a202c;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: relative;
            height: 600px;
            min-width: 500px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a5568;
            margin: 0;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .supabase-section {
            background: #f0f8ff;
            color: #1e3a8a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #3b82f6;
        }

        .config-form {
            margin-bottom: 20px;
        }

        .config-form input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 10px;
        }

        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 500px;
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                padding: 15px;
                height: 450px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .chart-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        .analytics-summary {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .analytics-summary h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .analytics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .year-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .year-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

        .download-status {
            background: #e6fffa;
            color: #234e52;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #38b2ac;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>🏥 Mutuelle Calculateur</h1>
                <p>Calculez et analysez vos remboursements de mutuelle en toute confidentialité</p>
            </div>

            <div id="confidentialityNotice" class="privacy-notice">
                <strong>🔒 Confidentialité garantie :</strong> Vos documents sont traités localement dans votre navigateur. Aucune information personnelle n'est transmise.
            </div>



            <div id="descriptionNotice" class="privacy-notice" style="background: #e8f5e8; color: #2d5016; border-left-color: #68d391;">
                <strong>🎯 À quoi sert ce calculateur ?</strong>
                <div style="margin-top: 10px;">
                    Cette application calcule et analyse vos relevés de mutuelle pour déterminer automatiquement si votre mutuelle vous fait gagner ou perdre de l'argent. Elle compare vos cotisations annuelles avec les remboursements reçus pour vous donner un verdict clair : <strong>Êtes-vous gagnant ou perdant avec votre mutuelle ?</strong>
                </div>
                <div style="margin-top: 10px;">
                    L'outil génère des graphiques détaillés, calcule vos déficits ou bénéfices par année, et vous aide à prendre des décisions éclairées sur votre couverture santé.
                </div>
            </div>

            <div id="instructionsNotice" class="privacy-notice" style="background: #fff3cd; color: #856404; border-left-color: #ffc107;">
                <strong>📋 Mode d'emploi :</strong>
                <div style="margin-top: 10px;">
                    <div><strong>Étape 1 :</strong> Connectez-vous sur votre espace mutuelle</div>
                    <div style="margin-top: 5px;"><strong>Étape 2 :</strong> Téléchargez tous vos remboursements et prestations versées directement aux professionnels de santé</div>
                    <div style="margin-top: 5px;"><strong>Étape 3 :</strong> Glissez votre relevé mutuelle ci-dessous</div>
                </div>
            </div>

            <div id="uploadSection" class="upload-section">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">Glissez votre relevé de mutuelle ici</div>
                    <div class="upload-subtext">ou cliquez pour sélectionner un fichier PDF</div>
                </div>
                <input type="file" id="fileInput" accept=".pdf" onchange="handleFileSelect(event)">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    Choisir un fichier
                </button>
            </div>

            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>Analyse du document en cours...</p>
            </div>

            <div id="resultsSection" class="results-section">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('remboursements')">Remboursements</button>
                    <button class="tab" onclick="switchTab('cotisations')">Cotisations</button>
                    <button class="tab" onclick="switchTab('analytics')">Synthèse</button>
                </div>

                <div id="remboursementsTab" class="tab-content active">
                    <div class="privacy-notice" style="margin-bottom: 20px;">
                        <strong>ℹ️ Information importante :</strong> Les remboursements incluent aussi les prestations payées aux Professionnels de Santé si elles sont présentes sur le document fourni.
                    </div>
                    <div class="details-table">
                        <div class="table-controls">
                            <label>Trier par date :</label>
                            <button class="btn btn-small" onclick="sortTable('asc')">↑ Croissant</button>
                            <button class="btn btn-small" onclick="sortTable('desc')">↓ Décroissant</button>
                        </div>
                        <table id="detailsTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('date')">Date</th>
                                    <th>Sécurité Sociale</th>
                                    <th>Mutuelle (MNT)</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Details will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="cotisationsTab" class="tab-content">
                    <div id="cotisationsContent">
                        <!-- Cotisations form will be inserted here -->
                    </div>
                </div>

                <div id="analyticsTab" class="tab-content">
                    <div id="analyticsContent">
                        <!-- Analytics will be inserted here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="resetApp()">
                            🔄 Analyser un nouveau fichier
                        </button>
                    </div>
                </div>
            </div>

            <div id="downloadStatus" class="download-status">
                PDF généré avec succès !
            </div>
            
        </div>
        
        <footer style="text-align: center; margin-top: 40px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px; backdrop-filter: blur(10px);">
            <div style="color: rgba(255,255,255,0.9); font-size: 14px;">
                <a href="mentions.html" style="color: rgba(255,255,255,0.9); text-decoration: none; margin: 0 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 5px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Mentions légales</a>
                <span style="color: rgba(255,255,255,0.5);">|</span>
                <a href="confidentialite.html" style="color: rgba(255,255,255,0.9); text-decoration: none; margin: 0 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 5px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Confidentialité</a>
                <span style="color: rgba(255,255,255,0.5);">|</span>
                <a href="cgu.html" style="color: rgba(255,255,255,0.9); text-decoration: none; margin: 0 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 5px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">CGU</a>
                <span style="color: rgba(255,255,255,0.5);">|</span>
                <a href="contact.html" style="color: rgba(255,255,255,0.9); text-decoration: none; margin: 0 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 5px; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Contact</a>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Configuration PDF.js avec HTTPS
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Supprimer les warnings de la console
        const originalWarn = console.warn;
        console.warn = function(message) {
            if (message && message.toString().includes('Setting up fake worker')) {
                return;
            }
            originalWarn.apply(console, arguments);
        };

        // Variables globales
        let analysisData = null;
        let cotisationsData = {};
        let currentSortOrder = 'desc';
        let charts = {};
        let supabaseClient = null;

        // Configuration Supabase fixe (remplacez par vos vraies valeurs)
        const SUPABASE_CONFIG = {
            url: 'https://YOUR_PROJECT_ID.supabase.co',
            key: 'YOUR_ANON_KEY_HERE'
        };

        // Initialisation automatique de Supabase au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initSupabase();
        });

        function initSupabase() {
            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = function() {
                    if (window.supabase && SUPABASE_CONFIG.url && SUPABASE_CONFIG.key) {
                        supabaseClient = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                        console.log('Supabase initialisé');
                    }
                };
                document.head.appendChild(script);
            } catch (error) {
                console.error('Erreur lors de l\'initialisation de Supabase:', error);
            }
        }

        function checkConsentAndDownload() {
            const consentCheckbox = document.getElementById('dataConsent');
            
            if (!consentCheckbox.checked) {
                alert('⚠️ Vous devez accepter le partage anonyme des données pour télécharger le rapport complet.\n\nCela nous aide à améliorer le service pour tous les utilisateurs.');
                consentCheckbox.focus();
                return;
            }

            // Sauvegarder les données d'abord, puis télécharger
            saveDataToSupabase().then(() => {
                downloadAllChartsAsPDF();
            }).catch((error) => {
                console.error('Erreur lors de la sauvegarde:', error);
                // Permettre le téléchargement même si la sauvegarde échoue
                downloadAllChartsAsPDF();
            });
        }

        // Structure des données pour Supabase
        function prepareDataForSupabase() {
            if (!analysisData || Object.keys(cotisationsData).length === 0) {
                return null;
            }

            const dataToSave = {
                mutuelle_name: analysisData.mutuelle || 'Non identifiée',
                created_at: new Date().toISOString(),
                years_data: {}
            };

            // Pour chaque année avec des données de cotisation
            Object.keys(cotisationsData).forEach(year => {
                const yearData = cotisationsData[year];
                const analysisYearData = analysisData.totalByYear[year] || { mutuelle: 0, secu: 0 };
                
                // Compter le nombre de remboursements pour cette année
                const reimbursementsThisYear = [
                    ...analysisData.reimbursements,
                    ...analysisData.pharmacyPayments
                ].filter(item => item.date && item.date.endsWith('/' + year));

                dataToSave.years_data[year] = {
                    nombre_remboursements: reimbursementsThisYear.length,
                    cotisation_personnelle: yearData.votreCotisationAnnuelle || 0,
                    contribution_employeur: yearData.employeurAnnuel || 0,
                    bilan: yearData.deficit || 0,
                    total_remboursement_mutuelle: analysisYearData.mutuelle || 0,
                    total_remboursement_secu: analysisYearData.secu || 0
                };
            });

            return dataToSave;
        }

        async function saveDataToSupabase() {
            if (!supabaseClient) {
                console.warn('Supabase non initialisé');
                return Promise.reject(new Error('Supabase non disponible'));
            }

            const dataToSave = prepareDataForSupabase();
            if (!dataToSave) {
                console.warn('Aucune donnée à sauvegarder');
                return Promise.reject(new Error('Aucune donnée disponible'));
            }

            try {
                const { data, error } = await supabaseClient
                    .from('mutuelle_data')
                    .insert([dataToSave]);

                if (error) {
                    throw error;
                }

                console.log('Données sauvegardées avec succès:', dataToSave);
                return Promise.resolve(data);

            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                return Promise.reject(error);
            }
        }

        // Gestion du drag & drop
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                processFile(file);
            }
        }

        async function processFile(file) {
            showLoading();
            
            try {
                const text = await extractTextFromPDF(file);
                analysisData = await analyzeDocument(text);
                displayResults(analysisData);
            } catch (error) {
                showError('Erreur lors du traitement du fichier: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText;
        }

        async function analyzeDocument(text) {
            const data = {
                beneficiary: '',
                mutuelle: '',
                period: '',
                totalReimbursements: 0,
                totalMutuelle: 0,
                totalSecu: 0,
                reimbursements: [],
                pharmacyPayments: [],
                totalByYear: {},
                totalByMonth: {}
            };

            // Extraction du nom du bénéficiaire
            const nameMatch = text.match(/([A-Z]+\s+[A-Z]+)\s+\d+\s+RUE/);
            if (nameMatch) {
                data.beneficiary = nameMatch[1];
            }

            // Extraction du nom de la mutuelle avec débogage
            console.log("Texte du PDF (premiers 500 caractères):", text.substring(0, 500));
            
            const mutuellePatterns = [
                // Patterns génériques flexibles
                /mutuelle\s+([a-z\s]+)/gi,
                /mnt[\s:]([a-z\s]+)/gi,
                /organisme[\s:]([a-z\s]+)/gi,
                /assureur[\s:]([a-z\s]+)/gi,
                
                // Mutuelles spécifiques (insensible à la casse)
                /(harmonie[\s\-]?mutuelle)/gi,
                /(mutuelle[\s\-]?generale)/gi,
                /(mgen)/gi,
                /(maaf[\s\-]?sante)/gi,
                /(malakoff[\s\-]?humanis)/gi,
                /(allianz[\s\-]?sante)/gi,
                /(axa[\s\-]?sante)/gi,
                /(groupama)/gi,
                /(macif[\s\-]?mutualite)/gi,
                /(matmut)/gi,
                /(maif[\s\-]?sante)/gi,
                /(mutex)/gi,
                /(myriade[\s\-]?mutuelle)/gi,
                /(adrea[\s\-]?mutuelle)/gi,
                /(mutuelle[\s\-]?familiale)/gi,
                /(mutuelle[\s\-]?des[\s\-]?motards)/gi,
                /(smi)/gi,
                /(smeba)/gi,
                /(smerep)/gi,
                /(lmde)/gi,
                /(emevia)/gi,
                /(heyme)/gi,
                /(mep)/gi,
                /(mnh)/gi,
                /(mutuelle[\s\-]?nationale[\s\-]?territoriale)/gi,
                /(mnt)/gi,
                /(mutuelle[\s\-]?integralis)/gi,
                /(mutuelle[\s\-]?bleue)/gi,
                /(mutuelle[\s\-]?verte)/gi,
                /(apivia[\s\-]?mutuelle)/gi,
                /(vyv)/gi,
                /(eovi[\s\-]?mcd)/gi,
                /(henner)/gi,
                /(april)/gi,
                /(swiss[\s\-]?life)/gi,
                /(generali)/gi,
                /(alptis)/gi,
                /(ccmo[\s\-]?mutuelle)/gi,
                /(mgc)/gi,
                /(prevadies)/gi,
                /(radiance[\s\-]?mutuelle)/gi,
                /(solimut)/gi
            ];
            
            for (const pattern of mutuellePatterns) {
                const match = text.match(pattern);
                if (match) {
                    data.mutuelle = match[0].trim();
                    console.log("Mutuelle trouvée:", data.mutuelle);
                    break;
                }
            }
            
            // Si pas trouvé, recherche plus large
            if (!data.mutuelle) {
                // Chercher des mots-clés dans le texte
                const keywords = ['MUTUELLE', 'MNT', 'MGEN', 'HARMONIE', 'GROUPAMA', 'MAAF', 'AXA', 'ALLIANZ'];
                for (const keyword of keywords) {
                    if (text.toUpperCase().includes(keyword)) {
                        data.mutuelle = keyword;
                        console.log("Mutuelle trouvée par mot-clé:", data.mutuelle);
                        break;
                    }
                }
            }
            
            // Fallback: chercher le premier mot en majuscules de plus de 3 lettres
            if (!data.mutuelle) {
                const fallbackMatch = text.match(/\b([A-Z]{4,})\b/);
                if (fallbackMatch && !['DATE', 'EURO', 'REMB', 'SECU'].includes(fallbackMatch[1])) {
                    data.mutuelle = fallbackMatch[1];
                    console.log("Mutuelle trouvée par fallback:", data.mutuelle);
                }
            }

            // Extraction de la période
            const periodMatch = text.match(/Période du (\d{2}\/\d{2}\/\d{4}) au (\d{2}\/\d{2}\/\d{4})/);
            if (periodMatch) {
                data.period = `${periodMatch[1]} au ${periodMatch[2]}`;
            }

            // Extraction des remboursements directs
            const reimbursementPattern = /([^\n]+?)\s+(\d{2}\/\d{2}\/\d{4})\s+[A-Z\s]+\s+\d+\s+([\d,]+)\s€\s+([\d,]+)\s€/g;
            let match;
            while ((match = reimbursementPattern.exec(text)) !== null) {
                const care = match[1].trim();
                const date = match[2];
                const secuAmount = parseFloat(match[3].replace(',', '.'));
                const mutuelleAmount = parseFloat(match[4].replace(',', '.'));
                const year = date.split('/')[2];
                const month = `${year}-${date.split('/')[1].padStart(2, '0')}`;

                data.reimbursements.push({
                    date: date,
                    care: care,
                    secuAmount: secuAmount,
                    mutuelleAmount: mutuelleAmount,
                    total: secuAmount + mutuelleAmount,
                    resteACharge: 0
                });

                data.totalSecu += secuAmount;
                data.totalMutuelle += mutuelleAmount;
                data.totalReimbursements += secuAmount + mutuelleAmount;

                // Agrégation par année
                if (!data.totalByYear[year]) {
                    data.totalByYear[year] = { mutuelle: 0, secu: 0 };
                }
                data.totalByYear[year].mutuelle += mutuelleAmount;
                data.totalByYear[year].secu += secuAmount;

                // Agrégation par mois
                if (!data.totalByMonth[month]) {
                    data.totalByMonth[month] = { mutuelle: 0, secu: 0 };
                }
                data.totalByMonth[month].mutuelle += mutuelleAmount;
                data.totalByMonth[month].secu += secuAmount;
            }

            // Extraction des paiements pharmacie
            const pharmacyPattern = /([^\n]+?)\s+(\d{2}\/\d{2}\/\d{4})\s+\d{2}\/\d{2}\/\d{4}\s+[A-Z\s]+\s+[A-Z\s]+\s+([\d,]+)\s€\s+([\d,]+)\s€/g;
            while ((match = pharmacyPattern.exec(text)) !== null) {
                const item = match[1].trim();
                const date = match[2];
                const secuAmount = parseFloat(match[3].replace(',', '.'));
                const mutuelleAmount = parseFloat(match[4].replace(',', '.'));

                if (mutuelleAmount > 0) {
                    data.pharmacyPayments.push({
                        date: date,
                        item: item,
                        secuAmount: secuAmount,
                        mutuelleAmount: mutuelleAmount,
                        total: secuAmount + mutuelleAmount
                    });

                    const year = date.split('/')[2];
                    const month = `${year}-${date.split('/')[1].padStart(2, '0')}`;

                    // Agrégation par année
                    if (!data.totalByYear[year]) {
                        data.totalByYear[year] = { mutuelle: 0, secu: 0 };
                    }
                    data.totalByYear[year].mutuelle += mutuelleAmount;
                    data.totalByYear[year].secu += secuAmount;

                    // Agrégation par mois
                    if (!data.totalByMonth[month]) {
                        data.totalByMonth[month] = { mutuelle: 0, secu: 0 };
                    }
                    data.totalByMonth[month].mutuelle += mutuelleAmount;
                    data.totalByMonth[month].secu += secuAmount;

                    data.totalMutuelle += mutuelleAmount;
                    data.totalSecu += secuAmount;
                    data.totalReimbursements += mutuelleAmount + secuAmount;
                }
            }

            return data;
        }

        function displayResults(data) {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('instructionsNotice').style.display = 'none';
            document.getElementById('descriptionNotice').style.display = 'none';
            document.getElementById('confidentialityNotice').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            displayDetails(data);
            displayCotisations(data);
            displayAnalytics(data);
        }

        function displayDetails(data) {
            const tbody = document.getElementById('detailsTable').querySelector('tbody');
            let allItems = [];

            data.reimbursements.forEach(item => {
                allItems.push({
                    date: item.date,
                    secuAmount: item.secuAmount,
                    mutuelleAmount: item.mutuelleAmount,
                    resteACharge: item.resteACharge,
                    total: item.total
                });
            });

            data.pharmacyPayments.forEach(item => {
                allItems.push({
                    date: item.date,
                    secuAmount: item.secuAmount,
                    mutuelleAmount: item.mutuelleAmount,
                    resteACharge: 0,
                    total: item.total
                });
            });

            sortItems(allItems, currentSortOrder);
            
            let rows = '';
            allItems.forEach(item => {
                rows += `
                    <tr>
                        <td>${item.date}</td>
                        <td class="amount-cell positive">${item.secuAmount.toFixed(2)}€</td>
                        <td class="amount-cell positive">${item.mutuelleAmount.toFixed(2)}€</td>
                        <td class="amount-cell positive"><strong>${item.total.toFixed(2)}€</strong></td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows;
        }

        function sortTable(order) {
            if (order) {
                currentSortOrder = order;
            }
            displayDetails(analysisData);
        }

        function sortItems(items, order) {
            items.sort((a, b) => {
                const dateA = new Date(a.date.split('/').reverse().join('-'));
                const dateB = new Date(b.date.split('/').reverse().join('-'));
                
                if (order === 'asc') {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            });
        }

        function displayCotisations(data) {
            const cotisationsContent = document.getElementById('cotisationsContent');
            const years = Object.keys(data.totalByYear).sort((a, b) => b - a);
            
            if (years.length === 0) return;
            
            if (!window.selectedYear) {
                window.selectedYear = years[0];
            }
            
            let yearOptions = '';
            years.forEach(year => {
                const isSelected = year === window.selectedYear ? 'selected' : '';
                yearOptions += `<option value="${year}" ${isSelected}>${year}</option>`;
            });

            cotisationsContent.innerHTML = `
                <div class="cotisation-form">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">Gestion des Cotisations Mutuelles</h3>
                    <p style="margin-bottom: 20px; color: #718096;">
                        Renseignez vos cotisations mensuelles pour calculer le coût réel de votre mutuelle.
                    </p>
                    
                    <div class="year-selector" style="margin-bottom: 20px;">
                        <label style="font-weight: 500; color: #4a5568; margin-bottom: 10px; display: block;">
                            Sélectionnez une année :
                        </label>
                        <select id="yearSelector" onchange="selectYearFromDropdown()">
                            ${yearOptions}
                        </select>
                    </div>
                    
                    <div id="year-content">
                        <!-- Le contenu de l'année sélectionnée sera affiché ici -->
                    </div>
                    
                    <div class="privacy-notice" style="background: #f0f8ff; color: #1e3a8a; border-left-color: #3b82f6; margin-top: 20px;">
                        <strong>📊 Note sur le bilan :</strong> Un bilan positif indique un bénéfice (vous récupérez plus que ce que vous payez), un bilan négatif indique un déficit (vous payez plus que ce que vous récupérez).
                    </div>
                    
                    <div class="privacy-notice" style="background: #fef3c7; color: #92400e; border-left-color: #f59e0b; margin-top: 15px;">
                        <strong>⚠️ Avertissement :</strong> Les résultats sont indicatifs et fournis à titre informatif uniquement. Vérifiez toujours les calculs avec vos documents officiels. L'éditeur ne saurait être tenu responsable d'erreurs de calcul.
                    </div>
                </div>
            `;
            
            displayYearContent(window.selectedYear, data);
        }

        function selectYear(year) {
            window.selectedYear = year;
            displayYearContent(year, analysisData);
        }

        function selectYearFromDropdown() {
            const yearSelector = document.getElementById('yearSelector');
            const selectedYear = yearSelector.value;
            window.selectedYear = selectedYear;
            displayYearContent(selectedYear, analysisData);
        }

        function displayYearContent(year, data) {
            const yearContent = document.getElementById('year-content');
            
            yearContent.innerHTML = `
                <div class="year-section">
                    <div class="year-title">Année ${year}</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cotisation-${year}">Total cotisation mensuelle :</label>
                            <input type="number" id="cotisation-${year}" 
                                   placeholder="Ex: 85.50" step="0.01" 
                                   value="${cotisationsData[year] ? cotisationsData[year].cotisationMensuelle : ''}"
                                   onchange="calculateCotisations('${year}')">
                        </div>
                        <div class="form-group">
                            <label for="employeur-${year}">Contribution employeur mensuelle :</label>
                            <input type="number" id="employeur-${year}" 
                                   placeholder="Ex: 42.75" step="0.01" 
                                   value="${cotisationsData[year] ? cotisationsData[year].employeurMensuel : ''}"
                                   onchange="calculateCotisations('${year}')">
                        </div>
                    </div>
                    <div class="calculations" id="calc-${year}">
                        <div class="calc-row">
                            <span>Total cotisation annuelle :</span>
                            <span id="total-cotisation-${year}">${cotisationsData[year] ? cotisationsData[year].totalCotisationAnnuelle.toFixed(2) + '€' : '0.00€'}</span>
                        </div>
                        <div class="calc-row">
                            <span>Cotisation annuelle (vous) :</span>
                            <span id="votre-cotisation-${year}">${cotisationsData[year] ? cotisationsData[year].votreCotisationAnnuelle.toFixed(2) + '€' : '0.00€'}</span>
                        </div>
                        <div class="calc-row">
                            <span>Contribution employeur annuelle :</span>
                            <span id="contrib-employeur-${year}">${cotisationsData[year] ? cotisationsData[year].employeurAnnuel.toFixed(2) + '€' : '0.00€'}</span>
                        </div>
                        <div class="calc-row">
                            <span>Total remboursements reçus :</span>
                            <span id="rembours-recu-${year}">${data.totalByYear[year] ? data.totalByYear[year].mutuelle.toFixed(2) : '0.00'}€</span>
                        </div>
                        <div class="calc-row">
                            <span>Bilan :</span>
                            <span id="deficit-${year}" style="color: ${cotisationsData[year] && cotisationsData[year].deficit > 0 ? '#38a169' : '#e53e3e'}">
                                ${cotisationsData[year] ? cotisationsData[year].deficit.toFixed(2) + '€' : '0.00€'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateCotisations(year) {
            const cotisationInput = document.getElementById(`cotisation-${year}`);
            const employeurInput = document.getElementById(`employeur-${year}`);
            
            const totalCotisationMensuelle = parseFloat(cotisationInput.value) || 0;
            const employeurMensuel = parseFloat(employeurInput.value) || 0;
            
            const totalCotisationAnnuelle = totalCotisationMensuelle * 12;
            const employeurAnnuel = employeurMensuel * 12;
            const votreCotisationAnnuelle = totalCotisationAnnuelle - employeurAnnuel;
            
            const remboursementsRecus = analysisData.totalByYear[year] ? 
                analysisData.totalByYear[year].mutuelle : 0;
            const deficit = remboursementsRecus - votreCotisationAnnuelle;
            
            // Mise à jour de l'affichage
            document.getElementById(`total-cotisation-${year}`).textContent = totalCotisationAnnuelle.toFixed(2) + '€';
            document.getElementById(`votre-cotisation-${year}`).textContent = votreCotisationAnnuelle.toFixed(2) + '€';
            document.getElementById(`contrib-employeur-${year}`).textContent = employeurAnnuel.toFixed(2) + '€';
            document.getElementById(`rembours-recu-${year}`).textContent = remboursementsRecus.toFixed(2) + '€';
            
            const deficitElement = document.getElementById(`deficit-${year}`);
            deficitElement.textContent = deficit.toFixed(2) + '€';
            deficitElement.style.color = deficit > 0 ? '#38a169' : '#e53e3e';
            
            // Sauvegarde des données
            cotisationsData[year] = {
                cotisationMensuelle: totalCotisationMensuelle,
                employeurMensuel: employeurMensuel,
                votreCotisationAnnuelle: votreCotisationAnnuelle,
                employeurAnnuel: employeurAnnuel,
                totalCotisationAnnuelle: totalCotisationAnnuelle,
                remboursementsRecus: remboursementsRecus,
                deficit: deficit
            };
        }

        function displayAnalytics(data) {
            const analyticsContent = document.getElementById('analyticsContent');
            
            const totalItems = data.reimbursements.length + data.pharmacyPayments.length;
            const avgReimbursement = totalItems > 0 ? data.totalReimbursements / totalItems : 0;
            const avgMutuelleReimbursement = totalItems > 0 ? data.totalMutuelle / totalItems : 0;
            const avgSecuReimbursement = totalItems > 0 ? data.totalSecu / totalItems : 0;
            
            // Calcul du déficit total et moyen
            const years = Object.keys(data.totalByYear).sort();
            let totalDeficit = 0;
            let yearsWithData = 0;
            
            years.forEach(year => {
                if (cotisationsData[year] && cotisationsData[year].deficit) {
                    totalDeficit += cotisationsData[year].deficit;
                    yearsWithData++;
                }
            });
            
            const avgDeficit = yearsWithData > 0 ? totalDeficit / yearsWithData : 0;

            // Destruction des anciens graphiques
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            analyticsContent.innerHTML = `
                ${data.mutuelle ? `<div class="privacy-notice" style="background: #e8f5e8; color: #2d5016; border-left-color: #68d391; margin-bottom: 20px; text-align: center;">
                    <strong>🏥 Mutuelle analysée : ${data.mutuelle}</strong>
                </div>` : ''}
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Total Remboursements Mutuelle</h3>
                        <div class="amount">${data.totalMutuelle.toFixed(2)}€</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Remboursements Sécurité Sociale</h3>
                        <div class="amount">${data.totalSecu.toFixed(2)}€</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Bilan Mutuelle</h3>
                        <div class="amount" style="color: ${totalDeficit > 0 ? '#38a169' : '#e53e3e'}">${totalDeficit.toFixed(2)}€</div>
                    </div>
                    <div class="summary-card">
                        <h3>Bilan Mutuelle Annuel Moyen</h3>
                        <div class="amount" style="color: ${avgDeficit > 0 ? '#38a169' : '#e53e3e'}">${avgDeficit.toFixed(2)}€</div>
                    </div>
                    <div class="summary-card">
                        <h3>Nombre de remboursements</h3>
                        <div class="amount">${totalItems}</div>
                    </div>
                    <div class="summary-card">
                        <h3>Remboursement Mutuelle moyen</h3>
                        <div class="amount">${avgMutuelleReimbursement.toFixed(2)}€</div>
                    </div>
                    <div class="summary-card">
                        <h3>Remboursement Sécurité Sociale moyen</h3>
                        <div class="amount">${avgSecuReimbursement.toFixed(2)}€</div>
                    </div>
                </div>
                
                <div class="chart-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">📊 Analyse financière par année</h3>
                        </div>
                        <canvas id="yearlyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">🥧 Répartition Mutuelle vs Sécurité Sociale</h3>
                        </div>
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                
                <!-- Section Consentement pour les statistiques -->
                <div class="privacy-notice" style="background: #fff3cd; color: #856404; border-left-color: #ffc107; margin-bottom: 20px;">
                    <h3>📊 Contribution aux statistiques anonymes</h3>
                    <p>Pour améliorer notre service et fournir des analyses comparatives, nous collectons des données anonymisées :</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Nom de votre mutuelle</li>
                        <li>Montants des cotisations et remboursements (sans dates ni détails personnels)</li>
                        <li>Bilans financiers calculés</li>
                    </ul>
                    <p><strong>Aucune donnée personnelle identifiante n'est collectée.</strong></p>
                    
                    <label style="display: flex; align-items: center; margin-top: 15px; font-weight: bold; cursor: pointer;">
                        <input type="checkbox" id="dataConsent" style="margin-right: 10px; transform: scale(1.2);">
                        J'accepte le partage anonyme de mes données pour contribuer aux statistiques
                    </label>
                    <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                        ✅ Requis pour télécharger le rapport complet
                    </p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-download" onclick="checkConsentAndDownload()" id="downloadReportBtn">
                        📊 Télécharger le rapport complet
                    </button>
                </div>
            `;

            // Créer les graphiques après l'insertion du HTML
            setTimeout(() => {
                createYearlyChart(data);
                createPieChart(data);
            }, 100);
        }

        function createYearlyChart(data) {
            const ctx = document.getElementById('yearlyChart');
            if (!ctx) return;

            const years = Object.keys(data.totalByYear).sort();
            const mutuelleData = years.map(year => data.totalByYear[year].mutuelle);
            const secuData = years.map(year => data.totalByYear[year].secu);
            
            const yourCotisationsData = years.map(year => {
                return cotisationsData[year] ? cotisationsData[year].votreCotisationAnnuelle : 0;
            });
            const deficitData = years.map(year => {
                return cotisationsData[year] ? cotisationsData[year].deficit : 0;
            });

            charts.yearly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Remboursement Mutuelle',
                        data: mutuelleData,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }, {
                        label: 'Remboursement Sécurité Sociale',
                        data: secuData,
                        backgroundColor: 'rgba(56, 178, 172, 0.8)',
                        borderColor: 'rgba(56, 178, 172, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }, {
                        label: 'Cotisation annuelle (vous)',
                        data: yourCotisationsData,
                        backgroundColor: 'rgba(255, 159, 64, 0.8)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }, {
                        label: 'Bilan',
                        data: deficitData,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 50,
                            left: 20,
                            right: 20
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'center',
                            maxWidth: 800,
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '500'
                                },
                                boxWidth: 10,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    return labels.map(label => {
                                        if (label.text === 'Cotisation annuelle (vous)') {
                                            label.text = 'Votre cotisation';
                                        }
                                        return label;
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(102, 126, 234, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '€';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                padding: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value.toFixed(0) + '€';
                                },
                                padding: 8
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function createPieChart(data) {
            const ctx = document.getElementById('pieChart');
            if (!ctx) return;

            charts.pie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mutuelle', 'Sécurité Sociale'],
                    datasets: [{
                        data: [data.totalMutuelle, data.totalSecu],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(56, 178, 172, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(56, 178, 172, 1)'
                        ],
                        borderWidth: 3,
                        hoverBackgroundColor: [
                            'rgba(102, 126, 234, 0.9)',
                            'rgba(56, 178, 172, 0.9)'
                        ],
                        cutout: '50%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30,
                            bottom: 80,
                            left: 30,
                            right: 30
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 25,
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                boxWidth: 18,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, index) => {
                                        const value = data.datasets[0].data[index];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label}: ${value.toFixed(2)}€ (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[index],
                                            hidden: false,
                                            index: index
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(102, 126, 234, 0.5)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed.toFixed(2) + '€ (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        async function downloadAllChartsAsPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                let yPos = 20;

                // Page de titre
                pdf.setFontSize(20);
                pdf.text('Rapport de Calcul', pdfWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                pdf.text('Remboursements de Mutuelle', pdfWidth / 2, yPos, { align: 'center' });
                yPos += 20;
                
                pdf.setFontSize(12);
                pdf.text(`Généré le ${new Date().toLocaleDateString('fr-FR')}`, pdfWidth / 2, yPos, { align: 'center' });
                yPos += 10;
                
                if (analysisData.period) {
                    pdf.text(`Période: ${analysisData.period}`, pdfWidth / 2, yPos, { align: 'center' });
                    yPos += 10;
                }
                
                if (analysisData.mutuelle) {
                    pdf.text(`Mutuelle: ${analysisData.mutuelle}`, pdfWidth / 2, yPos, { align: 'center' });
                    yPos += 20;
                } else {
                    yPos += 20;
                }

                // Synthèse financière complète
                const totalItems = analysisData.reimbursements.length + analysisData.pharmacyPayments.length;
                const avgReimbursement = totalItems > 0 ? analysisData.totalReimbursements / totalItems : 0;
                const avgMutuelleReimbursement = totalItems > 0 ? analysisData.totalMutuelle / totalItems : 0;
                const avgSecuReimbursement = totalItems > 0 ? analysisData.totalSecu / totalItems : 0;
                
                const years = Object.keys(analysisData.totalByYear).sort();
                let totalDeficit = 0;
                let yearsWithData = 0;
                
                years.forEach(year => {
                    if (cotisationsData[year] && cotisationsData[year].deficit) {
                        totalDeficit += cotisationsData[year].deficit;
                        yearsWithData++;
                    }
                });
                
                const avgDeficit = yearsWithData > 0 ? totalDeficit / yearsWithData : 0;

                pdf.setFontSize(14);
                pdf.text('Synthèse Financière', 20, yPos);
                yPos += 15;
                
                pdf.setFontSize(11);
                pdf.text(`Total remboursements Mutuelle: ${analysisData.totalMutuelle.toFixed(2)}€`, 20, yPos);
                yPos += 8;
                pdf.text(`Total remboursements Sécurité Sociale: ${analysisData.totalSecu.toFixed(2)}€`, 20, yPos);
                yPos += 8;
                pdf.text(`Total bilan Mutuelle: ${totalDeficit.toFixed(2)}€`, 20, yPos);
                yPos += 8;
                pdf.text(`Bilan Mutuelle annuel moyen: ${avgDeficit.toFixed(2)}€`, 20, yPos);
                yPos += 8;
                pdf.text(`Nombre de remboursements: ${totalItems}`, 20, yPos);
                yPos += 8;
                pdf.text(`Remboursement Mutuelle moyen: ${avgMutuelleReimbursement.toFixed(2)}€`, 20, yPos);
                yPos += 8;
                pdf.text(`Remboursement Sécurité Sociale moyen: ${avgSecuReimbursement.toFixed(2)}€`, 20, yPos);
                yPos += 20;

                // Tableau des cotisations
                if (Object.keys(cotisationsData).length > 0) {
                    pdf.setFontSize(14);
                    pdf.text('Détail des Cotisations par Année', 20, yPos);
                    yPos += 15;

                    // En-têtes du tableau
                    pdf.setFontSize(9);
                    const colWidths = [20, 30, 35, 30, 35, 35];
                    const colPositions = [20, 40, 70, 105, 135, 170];
                    const headers = ['Année', 'Cotisation/mois', 'Employeur/mois', 'Votre part/an', 'Remboursements/an', 'Bilan/an'];
                    
                    // Dessiner les en-têtes
                    pdf.setFillColor(102, 126, 234);
                    pdf.rect(20, yPos - 5, 170, 8, 'F');
                    pdf.setTextColor(255, 255, 255);
                    headers.forEach((header, i) => {
                        pdf.text(header, colPositions[i] + 2, yPos, { maxWidth: colWidths[i] - 4 });
                    });
                    yPos += 10;
                    
                    pdf.setTextColor(0, 0, 0);
                    
                    // Données du tableau
                    Object.keys(cotisationsData).sort().forEach((year, index) => {
                        const data = cotisationsData[year];
                        const rowData = [
                            year,
                            `${data.cotisationMensuelle.toFixed(2)}€`,
                            `${data.employeurMensuel.toFixed(2)}€`,
                            `${data.votreCotisationAnnuelle.toFixed(2)}€`,
                            `${data.remboursementsRecus.toFixed(2)}€`,
                            `${data.deficit.toFixed(2)}€`
                        ];
                        
                        // Alterner les couleurs de fond
                        if (index % 2 === 0) {
                            pdf.setFillColor(245, 245, 245);
                            pdf.rect(20, yPos - 5, 170, 8, 'F');
                        }
                        
                        rowData.forEach((cell, i) => {
                            pdf.text(cell, colPositions[i] + 2, yPos, { maxWidth: colWidths[i] - 4 });
                        });
                        yPos += 8;
                    });
                    yPos += 10;
                }

                // Ajouter les graphiques avec taille réduite
                const chartIds = ['yearlyChart', 'pieChart'];
                const chartTitles = ['Analyse financière par année', 'Répartition Mutuelle vs Sécurité Sociale'];

                for (let i = 0; i < chartIds.length; i++) {
                    const canvas = document.getElementById(chartIds[i]);
                    if (canvas) {
                        // Nouvelle page pour chaque graphique
                        pdf.addPage();

                        // Titre du graphique
                        pdf.setFontSize(16);
                        pdf.text(chartTitles[i], pdfWidth / 2, 20, { align: 'center' });

                        // Créer un canvas haute résolution pour le graphique
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        const scaleFactor = 3;
                        
                        tempCanvas.width = canvas.width * scaleFactor;
                        tempCanvas.height = canvas.height * scaleFactor;
                        tempCtx.scale(scaleFactor, scaleFactor);
                        
                        tempCtx.imageSmoothingEnabled = true;
                        tempCtx.imageSmoothingQuality = 'high';
                        
                        // Ajouter un fond blanc
                        tempCtx.fillStyle = '#ffffff';
                        tempCtx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        tempCtx.drawImage(canvas, 0, 0);
                        
                        const imgData = tempCanvas.toDataURL('image/jpeg', 0.95);
                        
                        // Dimensions plus petites pour les graphiques
                        const maxWidth = Math.min(pdfWidth - 60, 130);
                        const maxHeight = pdfHeight - 100;
                        
                        let imgWidth = maxWidth;
                        let imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        // Si trop haut, ajuster selon la hauteur
                        if (imgHeight > maxHeight) {
                            imgHeight = maxHeight;
                            imgWidth = (canvas.width * imgHeight) / canvas.height;
                        }
                        
                        const x = (pdfWidth - imgWidth) / 2;
                        const y = 50;

                        pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                    }
                }

                // Télécharger le PDF complet
                pdf.save('rapport-calcul-mutuelle.pdf');
                showDownloadSuccess();

            } catch (error) {
                showError('Erreur lors de la génération du PDF: ' + error.message);
            }
        }

        function showDownloadSuccess() {
            const statusDiv = document.getElementById('downloadStatus');
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Afficher l'onglet sélectionné
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Si on bascule vers l'onglet analytics, recréer les graphiques
            if (tabName === 'analytics' && analysisData) {
                setTimeout(() => {
                    displayAnalytics(analysisData);
                }, 100);
            }
        }

        function showLoading() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function showError(message) {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.style.display = 'block';
            
            let errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.remove();
            }
            
            errorDiv = document.createElement('div');
            errorDiv.id = 'errorMessage';
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = message;
            
            uploadSection.appendChild(errorDiv);
        }

        function resetApp() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('instructionsNotice').style.display = 'block';
            document.getElementById('descriptionNotice').style.display = 'block';
            document.getElementById('confidentialityNotice').style.display = 'block';
            document.getElementById('fileInput').value = '';
            
            // Réinitialiser le consentement (maintenant dans l'onglet Synthèse)
            const consentCheckbox = document.getElementById('dataConsent');
            if (consentCheckbox) {
                consentCheckbox.checked = false;
            }
            
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.remove();
            }
            
            // Détruire les graphiques existants
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
            
            analysisData = null;
            cotisationsData = {};
            currentSortOrder = 'desc';
            window.selectedYear = null;
        }
    </script>
</body>
</html>